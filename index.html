<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4C1D95">
    <title>40-Minute Synced Alarm</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #312e81 0%, #7e22ce 50%, #be185d 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: white;
            overflow-x: hidden;
        }
        
        .app-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 30px;
            padding: 30px;
            max-width: 450px;
            width: 100%;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .sync-badge {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(16, 185, 129, 0.9);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
            animation: pulse-badge 2s infinite;
        }
        
        @keyframes pulse-badge {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .sync-dot {
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .header {
            text-align: center;
            margin-bottom: 25px;
            margin-top: 15px;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 5px;
        }
        
        .header p {
            opacity: 0.8;
            font-size: 14px;
        }
        
        .current-time-box {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(147, 51, 234, 0.3));
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        
        .current-time-label {
            opacity: 0.8;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        
        .current-time {
            font-size: 36px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
        }
        
        .countdown-container {
            position: relative;
            width: 280px;
            height: 280px;
            margin: 0 auto 40px;
        }
        
        .countdown-svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }
        
        .countdown-circle-bg {
            fill: none;
            stroke: rgba(255, 255, 255, 0.1);
            stroke-width: 12;
        }
        
        .countdown-circle {
            fill: none;
            stroke: white;
            stroke-width: 12;
            stroke-linecap: round;
            transition: stroke-dashoffset 1s linear, stroke 0.3s;
            filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.5));
        }
        
        .countdown-circle.warning {
            stroke: #fbbf24;
        }
        
        .countdown-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        
        .countdown-label {
            opacity: 0.7;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        
        .countdown-time {
            font-size: 64px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            transition: color 0.3s;
        }
        
        .countdown-time.warning {
            color: #fde047;
        }
        
        .countdown-status {
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
            opacity: 0.7;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #9ca3af;
        }
        
        .status-dot.active {
            background: #4ade80;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .btn {
            flex: 1;
            padding: 18px;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .btn-start {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        .btn-start:hover:not(:disabled) {
            transform: scale(1.05);
        }
        
        .btn-start:disabled {
            background: rgba(107, 114, 128, 0.5);
            color: rgba(255, 255, 255, 0.5);
            cursor: not-allowed;
        }
        
        .btn-stop {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        
        .btn-stop:hover {
            transform: scale(1.05);
        }
        
        .info-box {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 12px;
            text-align: center;
            font-size: 12px;
            opacity: 0.9;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 10px;
        }
        
        .sync-info {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.4);
        }
        
        .warning-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeIn 0.3s;
        }
        
        .warning-overlay.show {
            display: flex;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .warning-box {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border-radius: 30px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
            margin: 20px;
            border: 4px solid #fde047;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: scaleIn 0.3s, pulse-warning 1s infinite;
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.8); }
            to { transform: scale(1); }
        }
        
        @keyframes pulse-warning {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        .warning-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: bounce 1s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .warning-title {
            font-size: 40px;
            font-weight: bold;
            color: #78350f;
            margin-bottom: 15px;
        }
        
        .warning-message {
            font-size: 24px;
            font-weight: bold;
            color: #78350f;
            margin-bottom: 10px;
        }
        
        .warning-sub {
            font-size: 16px;
            color: #92400e;
            margin-bottom: 30px;
        }
        
        .btn-dismiss {
            width: 100%;
            padding: 18px;
            background: #78350f;
            color: #fef3c7;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-dismiss:hover {
            background: #92400e;
        }
        
        .fullscreen-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.3s;
        }
        
        .fullscreen-btn:hover {
            opacity: 1;
        }
        
        .device-info {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 5px;
        }
        
        @media (max-width: 480px) {
            .app-container {
                padding: 20px;
            }
            
            .current-time {
                font-size: 28px;
            }
            
            .countdown-container {
                width: 240px;
                height: 240px;
            }
            
            .countdown-time {
                font-size: 52px;
            }
            
            .warning-title {
                font-size: 32px;
            }
        }
    </style>
</head>
<body>
    <div id="warningOverlay" class="warning-overlay">
        <div class="warning-box">
            <div class="warning-icon">‚ö†Ô∏è</div>
            <div class="warning-title">WARNING!</div>
            <div class="warning-message">Only 2 minutes remaining!</div>
            <div class="warning-sub">Get ready to complete your task</div>
            <button class="btn-dismiss" onclick="dismissWarning()">Got it!</button>
        </div>
    </div>

    <div class="app-container">
        <div class="sync-badge">
            <div class="sync-dot"></div>
            <span>SYNCED</span>
        </div>
        
        <button class="fullscreen-btn" onclick="toggleFullscreen()" title="Toggle Fullscreen">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
            </svg>
        </button>

        <div class="header">
            <h1>üîî Alarm Counter</h1>
            <p>40-Minute Synced Timer</p>
        </div>

        <div class="current-time-box">
            <div class="current-time-label">Current Time</div>
            <div class="current-time" id="currentTime">00:00:00</div>
        </div>

        <div class="countdown-container">
            <svg class="countdown-svg" viewBox="0 0 200 200">
                <circle class="countdown-circle-bg" cx="100" cy="100" r="85"/>
                <circle id="progressCircle" class="countdown-circle" cx="100" cy="100" r="85"/>
            </svg>
            <div class="countdown-display">
                <div class="countdown-label">Time Remaining</div>
                <div class="countdown-time" id="countdownTime">40:00</div>
                <div class="countdown-status">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">Paused</span>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-start" id="startBtn" onclick="startTimer()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                    <path d="M8 5v14l11-7z"/>
                </svg>
                Start
            </button>
            <button class="btn btn-stop" onclick="stopTimer()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                    <rect x="6" y="6" width="12" height="12"/>
                </svg>
                Stop
            </button>
        </div>

        <div class="info-box">
            ‚è∞ Warning alert appears 2 minutes before completion
        </div>
        
        <div class="info-box sync-info">
            üîÑ Syncs across all your devices in real-time
            <div class="device-info" id="deviceInfo">Connected devices: 1</div>
        </div>
    </div>

    <script type="module">
        // Generate unique device ID
        const DEVICE_ID = localStorage.getItem('deviceId') || 'device_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('deviceId', DEVICE_ID);

        // Sync configuration
        const SYNC_KEY = 'alarm_timer_sync';
        const SYNC_INTERVAL = 500; // Check for updates every 500ms
        
        let isActive = false;
        let timeLeft = 40 * 60;
        let warningShown = false;
        let localInterval = null;
        let wakeLock = null;
        let lastSyncTime = Date.now();

        const TOTAL_TIME = 40 * 60;
        const WARNING_TIME = 120;
        const CIRCLE_CIRCUMFERENCE = 2 * Math.PI * 85;

        // BroadcastChannel for same-device sync (multiple tabs)
        const channel = new BroadcastChannel('timer_sync');

        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // Cloud sync using localStorage + polling
        // For cross-device sync, this would connect to Firebase or similar
        function saveState() {
            const state = {
                isActive,
                timeLeft,
                warningShown,
                lastUpdate: Date.now(),
                deviceId: DEVICE_ID,
                startTime: isActive ? (Date.now() - (TOTAL_TIME - timeLeft) * 1000) : null
            };
            
            localStorage.setItem(SYNC_KEY, JSON.stringify(state));
            
            // Broadcast to other tabs on same device
            channel.postMessage(state);
        }

        function loadState() {
            const saved = localStorage.getItem(SYNC_KEY);
            if (saved) {
                try {
                    const state = JSON.parse(saved);
                    
                    // If timer is active, calculate current time based on start time
                    if (state.isActive && state.startTime) {
                        const elapsed = Math.floor((Date.now() - state.startTime) / 1000);
                        state.timeLeft = Math.max(0, TOTAL_TIME - elapsed);
                    }
                    
                    return state;
                } catch (e) {
                    console.error('Error loading state:', e);
                }
            }
            return null;
        }

        function syncFromCloud() {
            const cloudState = loadState();
            if (cloudState && cloudState.deviceId !== DEVICE_ID) {
                // Another device updated the timer
                if (cloudState.lastUpdate > lastSyncTime) {
                    isActive = cloudState.isActive;
                    timeLeft = cloudState.timeLeft;
                    warningShown = cloudState.warningShown;
                    lastSyncTime = cloudState.lastUpdate;
                    
                    updateUI();
                    
                    if (isActive && !localInterval) {
                        startLocalTimer();
                    } else if (!isActive && localInterval) {
                        stopLocalTimer();
                    }
                }
            }
        }

        // Listen for updates from other tabs
        channel.onmessage = (event) => {
            const state = event.data;
            if (state.deviceId !== DEVICE_ID) {
                isActive = state.isActive;
                timeLeft = state.timeLeft;
                warningShown = state.warningShown;
                lastSyncTime = Date.now();
                
                updateUI();
                
                if (isActive && !localInterval) {
                    startLocalTimer();
                } else if (!isActive && localInterval) {
                    stopLocalTimer();
                }
            }
        };

        // Sync every 500ms
        setInterval(syncFromCloud, SYNC_INTERVAL);

        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            });
            document.getElementById('currentTime').textContent = timeString;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function updateDisplay() {
            const timeDisplay = document.getElementById('countdownTime');
            const progressCircle = document.getElementById('progressCircle');
            
            timeDisplay.textContent = formatTime(timeLeft);
            
            const progress = (TOTAL_TIME - timeLeft) / TOTAL_TIME;
            const offset = CIRCLE_CIRCUMFERENCE * (1 - progress);
            progressCircle.style.strokeDasharray = CIRCLE_CIRCUMFERENCE;
            progressCircle.style.strokeDashoffset = offset;
            
            if (timeLeft <= WARNING_TIME) {
                timeDisplay.classList.add('warning');
                progressCircle.classList.add('warning');
            } else {
                timeDisplay.classList.remove('warning');
                progressCircle.classList.remove('warning');
            }
        }

        function updateUI() {
            updateDisplay();
            
            document.getElementById('startBtn').disabled = isActive;
            
            if (isActive) {
                document.getElementById('statusDot').classList.add('active');
                document.getElementById('statusText').textContent = 'Active';
            } else {
                document.getElementById('statusDot').classList.remove('active');
                document.getElementById('statusText').textContent = 'Paused';
            }
        }

        function playSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            const playTone = (freq, time, duration) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = freq;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime + time);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + time + duration);
                
                oscillator.start(audioContext.currentTime + time);
                oscillator.stop(audioContext.currentTime + time + duration);
            };
            
            playTone(523.25, 0, 0.8);
            playTone(659.25, 0.3, 0.8);
        }

        function vibrate(pattern) {
            if ('vibrate' in navigator) {
                navigator.vibrate(pattern);
            }
        }

        function showWarning() {
            document.getElementById('warningOverlay').classList.add('show');
            playSound();
            vibrate([200, 100, 200, 100, 200]);
            
            if (Notification.permission === 'granted') {
                new Notification('‚ö†Ô∏è Timer Warning', {
                    body: '2 minutes remaining on ALL devices!',
                    requireInteraction: true,
                    tag: 'timer-warning'
                });
            }
        }

        function dismissWarning() {
            document.getElementById('warningOverlay').classList.remove('show');
        }

        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                }
            } catch (err) {
                console.log('Wake Lock error:', err);
            }
        }

        function releaseWakeLock() {
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
            }
        }

        function startLocalTimer() {
            if (localInterval) return;
            
            requestWakeLock();
            
            localInterval = setInterval(() => {
                if (timeLeft > 0) {
                    timeLeft--;
                    
                    if (timeLeft === WARNING_TIME && !warningShown) {
                        showWarning();
                        warningShown = true;
                        saveState();
                    }
                    
                    if (timeLeft === 0) {
                        stopLocalTimer();
                        isActive = false;
                        playSound();
                        vibrate([400, 200, 400, 200, 400]);
                        
                        if (Notification.permission === 'granted') {
                            new Notification('‚è∞ Timer Complete', {
                                body: '40 minutes completed on all devices!',
                                requireInteraction: true,
                                tag: 'timer-complete'
                            });
                        }
                        
                        alert('‚è∞ 40 minutes completed!');
                        timeLeft = TOTAL_TIME;
                        warningShown = false;
                        releaseWakeLock();
                        saveState();
                    }
                    
                    updateDisplay();
                    
                    // Save state every second
                    if (timeLeft % 5 === 0) {
                        saveState();
                    }
                }
            }, 1000);
        }

        function stopLocalTimer() {
            if (localInterval) {
                clearInterval(localInterval);
                localInterval = null;
            }
            releaseWakeLock();
        }

        function startTimer() {
            if (isActive) return;
            
            isActive = true;
            warningShown = false;
            lastSyncTime = Date.now();
            
            updateUI();
            startLocalTimer();
            saveState();
        }

        function stopTimer() {
            stopLocalTimer();
            isActive = false;
            timeLeft = TOTAL_TIME;
            warningShown = false;
            
            updateUI();
            dismissWarning();
            saveState();
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // Initialize
        setInterval(updateCurrentTime, 1000);
        updateCurrentTime();
        
        // Load saved state on startup
        const savedState = loadState();
        if (savedState) {
            isActive = savedState.isActive;
            timeLeft = savedState.timeLeft;
            warningShown = savedState.warningShown;
            
            if (isActive) {
                startLocalTimer();
            }
        }
        
        updateUI();

        // Make functions global
        window.startTimer = startTimer;
        window.stopTimer = stopTimer;
        window.dismissWarning = dismissWarning;
        window.toggleFullscreen = toggleFullscreen;
    </script>
</body>
</html>
